name: CI

on:
 push:

jobs:
 build:
    runs-on: ubuntu-latest
    env:
      DOCKERIZED: true
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: project

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ./src/requirements.txt 

      - name: Start services with Docker Compose
        run: docker-compose up -d

      - name: Wait for healthchecks
        run: |
          timeout 120s sh -c 'until docker ps | grep flask_mysql | grep -q healthy && docker ps | grep flask_app | grep -q healthy; do echo "Waiting for containers to be healthy..."; sleep 2; done'

      - name: Test code with pytest
        run: pytest test/
          
      - name: Shutdown Docker Compose
        if: always()
        run: docker-compose down
